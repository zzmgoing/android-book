# 内存泄漏和性能优化

## 内存泄漏

内存泄漏（Memory Leak）是指程序中己动态分配的堆内存由于某种原因程序未释放或无法释放，造成系统内存的浪费，
从而导致程序运行速度减慢甚至系统崩溃(OOM)等严重后果。

**Android常见的内存泄漏：**

**一、静态变量**

静态变量的生命周期和应用的生命周期一样长。  
如果一个静态变量持有某个Activity的context，在Activity销毁时没有释放就会导致内存泄漏。

常见的有：单例模式、静态的View、Activity。

解决方案：使用全局的Application引用，在Activity的onDestroy()方法中释放不再使用的静态变量，将其置为Null。

**二、匿名内部类或非静态内部类**

匿名内部类和非静态的内部类都会隐式地持有其外部类的引用，静态内部类却不会。

常见的有：Thread、Handler、AsyncTask、TimerTask等，一般在处理多线程任务的时候。

解决方案：将非静态内部类改为静态内部类，在静态内部类中使用弱引用指向其所在的Activity。  
Handler在Activity的onDestroy()方法中移除队列中的消息，AsyncTask取消相应的任务cancel()，释放对象。

**三、资源对象**

在使用资源对象后应该在Activity销毁时及时关闭或注销，否则这些资源将不会被回收而导致内存泄漏。

常见的有：BraodcastReceiver，ContentObserver，File，Cursor，Stream，Bitmap，循环动画等。

解决方案：在Activity销毁时及时关闭或者注销，取消注册等。

**四、无用的监听**

例如电话状态监听，传感器监听，布局变化监听等在不使用后未移除导致内存泄漏。

解决方案：在使用后合适的地方取消监听。

**五、WebView**

WebView在Activity退出后没有被销毁。

解决方案：获取WebView的父容器移除该WebView，销毁该WebView。

**六、内存泄漏检测工具**

1、LeakCanary

LeakCanary 的原理很简单: 在 Activity 或 Fragment 被销毁后, 将他们的引用包装成一个 WeakReference, 然后将这个 WeakReference 关联到一个 ReferenceQueue 。查看ReferenceQueue中是否含有 Activity 或 Fragment 的引用。如果没有 触发GC 后再次查看。还是没有的话就说明回收成功, 否则可能发生了泄露. 这时候开始 dump 内存的信息,并分析泄露的引用链。

2、Android Profile


## 性能优化

**一、布局优化**

①布局复用，使用<include>标签重用layout。  
②提高显示速度，使用<ViewStub>延迟View加载。  
③减少层级，使用<merge>标签替换父级布局。  
④注意使用wrap_content，会增加measure计算成本。  
⑤删除控件中无用属性。  
⑥避免过度绘制(描述的是屏幕上的某个像素在同一帧的时间内被绘制了多次)。  

**二、绘制优化**

①onDraw()中不要创建新的局部对象。  
②onDraw()方法中不要做耗时的任务，会造成View的绘制过程不流畅。  

**三、内存泄漏优化**

见上面，优化代码使用方式，使用内存泄漏工具Memory Monitor、LeakCanary等检查代码。

**四、响应速度优化**

避免在主线程中做耗时操作，比如网络请求，文件解析等。应采用子线程，异步的方式进行。  
启动页(闪屏页)采用分布加载、异步加载、延期加载策略来提高应用启动速度。

**五、ListView/RecycleView及Bitmap优化**

①使用ViewHolder模式来提高效率。  
②异步加载：耗时的操作放在异步线程中。  
③ListView/RecycleView在滑动时停止加载和分页加载。  
④对大图片进行压缩，避免加载图片过大造成OOM。  

**六、线程优化**

尽量使用线程池，避免每次都创建一个Thread对象。

**七、APK瘦身**

①代码混淆：使用proGuard代码混淆器工具，它包括压缩、优化、混淆等功能。  
②资源优化：比如使用Android Lint删除冗余资源，资源文件最少化等。  
③图片优化：比如利用AAPT工具对PNG格式的图片做压缩处理，降低图片色彩位数等。  
④避免重复功能的库，使用 WebP图片格式等。  
⑤插件化：比如功能模块放在服务器上，按需下载，可以减少安装包大小。  


> [Android内存泄露整理](https://www.jianshu.com/p/8ade6b469cd7)  
> [Android性能优化总结](https://blog.csdn.net/xiangzhihong8/article/details/92800490)